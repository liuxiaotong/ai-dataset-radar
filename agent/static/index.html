<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Dataset Radar</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>tailwind.config={theme:{extend:{colors:{bg:'#0f172a',card:'#1e293b',border:'#334155',accent:'#38bdf8'}}}}</script>
<style>
  body { background: #0f172a; color: #e2e8f0; font-family: system-ui, sans-serif; }
  .tab-btn { padding: 0.5rem 1.25rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; }
  .tab-btn.active { background: #38bdf8; color: #0f172a; font-weight: 600; }
  .tab-btn:not(.active):hover { background: #1e293b; }
  table { width: 100%; border-collapse: collapse; }
  th { cursor: pointer; user-select: none; text-align: left; padding: 0.625rem 0.75rem; color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #334155; }
  th:hover { color: #e2e8f0; }
  td { padding: 0.625rem 0.75rem; border-bottom: 1px solid #1e293b; font-size: 0.875rem; }
  tr:hover td { background: #1e293b; }
  a { color: #38bdf8; text-decoration: none; }
  a:hover { text-decoration: underline; }
  .badge { display: inline-block; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 500; }
  .badge-blue { background: #1e3a5f; color: #7dd3fc; }
  .badge-green { background: #14532d; color: #86efac; }
  .badge-purple { background: #3b0764; color: #d8b4fe; }
  .badge-orange { background: #431407; color: #fdba74; }
  .badge-gray { background: #1e293b; color: #94a3b8; }
  .card { background: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; padding: 1.25rem; }
  .metric { font-size: 2rem; font-weight: 700; color: #f1f5f9; }
  .metric-label { font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem; }
  select, input[type=text] { background: #1e293b; border: 1px solid #334155; color: #e2e8f0; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; }
  select:focus, input:focus { outline: none; border-color: #38bdf8; }
  .loading { text-align: center; padding: 3rem; color: #64748b; }
  .panel { display: none; }
  .panel.active { display: block; }
  .blog-group { border: 1px solid #334155; border-radius: 0.5rem; margin-bottom: 0.5rem; }
  .blog-header { padding: 0.75rem 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .blog-header:hover { background: #1e293b; }
  .blog-body { display: none; padding: 0 1rem 0.75rem; }
  .blog-body.open { display: block; }
</style>
</head>
<body class="min-h-screen">

<!-- Header -->
<header class="border-b border-border px-6 py-4 flex items-center justify-between">
  <div class="flex items-center gap-3">
    <div class="text-xl font-bold text-accent">AI Dataset Radar</div>
    <div class="text-sm text-slate-500">ç«äº‰æƒ…æŠ¥ä»ªè¡¨ç›˜</div>
  </div>
  <div class="flex items-center gap-3">
    <span id="scan-time" class="text-xs text-slate-500"></span>
    <span id="health-dot" class="w-2.5 h-2.5 rounded-full bg-slate-600 inline-block"></span>
  </div>
</header>

<!-- Tabs -->
<nav class="px-6 py-3 flex gap-2 border-b border-border">
  <button class="tab-btn active" onclick="switchTab('overview')">æ¦‚è§ˆ</button>
  <button class="tab-btn" onclick="switchTab('datasets')">æ•°æ®é›†</button>
  <button class="tab-btn" onclick="switchTab('github')">GitHub</button>
  <button class="tab-btn" onclick="switchTab('papers')">è®ºæ–‡</button>
  <button class="tab-btn" onclick="switchTab('blogs')">åšå®¢</button>
  <button class="tab-btn" onclick="switchTab('reddit')">Reddit</button>
  <button class="tab-btn" onclick="switchTab('matrix')">ç«å“</button>
  <button class="tab-btn" onclick="switchTab('lineage')">è°±ç³»</button>
  <button class="tab-btn" onclick="switchTab('orggraph')">å›¾è°±</button>
  <button class="tab-btn" onclick="switchTab('search')">æœç´¢</button>
  <button class="tab-btn" onclick="switchTab('trends')">è¶‹åŠ¿</button>
  <button class="tab-btn" onclick="switchTab('alerts')">å‘Šè­¦</button>
</nav>

<!-- Content -->
<main class="px-6 py-5 max-w-[1400px] mx-auto">

  <!-- Overview Panel -->
  <div id="panel-overview" class="panel active">
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
      <div class="card"><div class="metric" id="m-datasets">-</div><div class="metric-label">æ•°æ®é›†</div></div>
      <div class="card"><div class="metric" id="m-repos">-</div><div class="metric-label">GitHub ä»“åº“</div></div>
      <div class="card"><div class="metric" id="m-papers">-</div><div class="metric-label">è®ºæ–‡</div></div>
      <div class="card"><div class="metric" id="m-blogs">-</div><div class="metric-label">åšå®¢æ–‡ç« </div></div>
      <div class="card"><div class="metric" id="m-reddit">-</div><div class="metric-label">Reddit å¸–å­</div></div>
    </div>
    <div class="grid md:grid-cols-2 gap-6">
      <div class="card">
        <h3 class="text-sm font-semibold text-slate-400 mb-3">æ•°æ®é›†åˆ†ç±»åˆ†å¸ƒ</h3>
        <div style="max-height:320px;display:flex;justify-content:center;"><canvas id="chart-categories"></canvas></div>
      </div>
      <div class="card">
        <h3 class="text-sm font-semibold text-slate-400 mb-3">çƒ­é—¨æ•°æ®é›† Top 10</h3>
        <table>
          <thead><tr><th>æ•°æ®é›†</th><th>ç±»åˆ«</th><th>ä¸‹è½½é‡</th></tr></thead>
          <tbody id="top-datasets"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Datasets Panel -->
  <div id="panel-datasets" class="panel">
    <div class="flex gap-3 mb-4 flex-wrap items-center">
      <select id="ds-category" onchange="loadDatasets()">
        <option value="">å…¨éƒ¨ç±»åˆ«</option>
        <option value="sft_instruction">SFT / Instruction</option>
        <option value="rlhf_preference">RLHF / Preference</option>
        <option value="reward_model">Reward Model</option>
        <option value="synthetic">Synthetic</option>
        <option value="agent_tool">Agent / Tool Use</option>
        <option value="multimodal">Multimodal</option>
        <option value="multilingual">Multilingual</option>
        <option value="rl_environment">RL / Embodied</option>
        <option value="code">Code</option>
        <option value="evaluation">Evaluation</option>
        <option value="other">Other</option>
      </select>
      <input id="ds-search" type="text" placeholder="æœç´¢æ•°æ®é›†..." oninput="filterDatasets()" class="w-56">
      <span id="ds-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div class="card overflow-x-auto">
      <table>
        <thead><tr>
          <th onclick="sortDatasets('id')">ID</th>
          <th onclick="sortDatasets('author')">ä½œè€…</th>
          <th onclick="sortDatasets('category')">ç±»åˆ«</th>
          <th onclick="sortDatasets('downloads')">ä¸‹è½½é‡</th>
          <th onclick="sortDatasets('likes')">ç‚¹èµ</th>
          <th>è¯­è¨€</th>
          <th>è®¸å¯è¯</th>
        </tr></thead>
        <tbody id="ds-tbody"></tbody>
      </table>
      <div id="ds-loading" class="loading">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- GitHub Panel -->
  <div id="panel-github" class="panel">
    <div class="flex gap-3 mb-4 items-center">
      <select id="gh-relevance" onchange="loadGithub()">
        <option value="all">å…¨éƒ¨ç›¸å…³æ€§</option>
        <option value="high" selected>é«˜ç›¸å…³</option>
        <option value="low">ä½ç›¸å…³</option>
      </select>
      <span id="gh-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div class="card overflow-x-auto">
      <table>
        <thead><tr>
          <th onclick="sortGithub('full_name')">ä»“åº“</th>
          <th onclick="sortGithub('stars')">Stars</th>
          <th>è¯­è¨€</th>
          <th>æ›´æ–°æ—¶é—´</th>
          <th>ç›¸å…³ä¿¡å·</th>
        </tr></thead>
        <tbody id="gh-tbody"></tbody>
      </table>
      <div id="gh-loading" class="loading">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- Papers Panel -->
  <div id="panel-papers" class="panel">
    <div class="flex gap-3 mb-4 items-center">
      <select id="pp-source" onchange="loadPapers()">
        <option value="all">å…¨éƒ¨æ¥æº</option>
        <option value="arxiv">arXiv</option>
        <option value="huggingface">HuggingFace</option>
      </select>
      <label class="flex items-center gap-1 text-xs text-slate-400 cursor-pointer"><input type="checkbox" id="pp-dataset" onchange="loadPapers()"> ä»…æ•°æ®é›†è®ºæ–‡</label>
      <span id="pp-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div id="pp-list" class="space-y-3"></div>
    <div id="pp-loading" class="loading">åŠ è½½ä¸­...</div>
  </div>

  <!-- Blogs Panel -->
  <div id="panel-blogs" class="panel">
    <div class="flex gap-3 mb-4 items-center">
      <select id="bl-category" onchange="loadBlogs()">
        <option value="all">å…¨éƒ¨åˆ†ç±»</option>
        <option value="us_frontier">US Frontier</option>
        <option value="us_emerging">US Emerging</option>
        <option value="china">China</option>
        <option value="research">Research</option>
        <option value="data_vendor">Data Vendor</option>
      </select>
      <span id="bl-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div id="bl-list" class="space-y-2"></div>
    <div id="bl-loading" class="loading">åŠ è½½ä¸­...</div>
  </div>

  <!-- Reddit Panel -->
  <div id="panel-reddit" class="panel">
    <div class="flex gap-3 mb-4 items-center">
      <select id="rd-subreddit" onchange="loadReddit()">
        <option value="">å…¨éƒ¨å­ç‰ˆ</option>
      </select>
      <input id="rd-min-score" type="text" placeholder="æœ€ä½åˆ†æ•°" class="w-28" value="5" onchange="loadReddit()">
      <span id="rd-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div class="card overflow-x-auto">
      <table>
        <thead><tr>
          <th onclick="sortReddit('score')">åˆ†æ•°</th>
          <th onclick="sortReddit('title')">æ ‡é¢˜</th>
          <th onclick="sortReddit('subreddit')">å­ç‰ˆ</th>
          <th onclick="sortReddit('num_comments')">è¯„è®º</th>
          <th>ä¿¡å·</th>
          <th>ä½œè€…</th>
        </tr></thead>
        <tbody id="rd-tbody"></tbody>
      </table>
      <div id="rd-loading" class="loading">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- Matrix Panel -->
  <div id="panel-matrix" class="panel">
    <div class="flex gap-3 mb-4 items-center">
      <span class="text-sm text-slate-400">ç»„ç»‡ Ã— æ•°æ®ç±»å‹ç«äº‰çŸ©é˜µ</span>
      <span id="mx-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div class="card overflow-x-auto">
      <table>
        <thead><tr>
          <th onclick="sortMatrix('org')">ç»„ç»‡</th>
          <th onclick="sortMatrix('datasets')">æ•°æ®é›†</th>
          <th onclick="sortMatrix('repos')">ä»“åº“</th>
          <th onclick="sortMatrix('papers')">è®ºæ–‡</th>
          <th onclick="sortMatrix('blogs')">åšå®¢</th>
          <th onclick="sortMatrix('total')">æ€»è®¡</th>
        </tr></thead>
        <tbody id="mx-tbody"></tbody>
      </table>
      <div id="mx-loading" class="loading">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- Lineage Panel -->
  <div id="panel-lineage" class="panel">
    <div class="flex gap-3 mb-4 items-center">
      <span class="text-sm text-slate-400">æ•°æ®é›†æ´¾ç”Ÿå…³ç³» / ç‰ˆæœ¬é“¾ / Fork</span>
      <span id="ln-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div class="grid md:grid-cols-3 gap-4 mb-4">
      <div class="card"><div class="metric" id="ln-edges">-</div><div class="metric-label">æ´¾ç”Ÿå…³ç³»</div></div>
      <div class="card"><div class="metric" id="ln-chains">-</div><div class="metric-label">ç‰ˆæœ¬é“¾</div></div>
      <div class="card"><div class="metric" id="ln-forks">-</div><div class="metric-label">Fork ç»„</div></div>
    </div>
    <div id="ln-sections" class="space-y-4"></div>
    <div id="ln-loading" class="loading">åŠ è½½ä¸­...</div>
  </div>

  <!-- Org Graph Panel -->
  <div id="panel-orggraph" class="panel">
    <div class="flex gap-3 mb-4 items-center">
      <span class="text-sm text-slate-400">ç»„ç»‡é—´åä½œ/ç«äº‰å…³ç³»</span>
      <span id="og-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div class="grid md:grid-cols-2 gap-6 mb-4">
      <div class="card">
        <h3 class="text-sm font-semibold text-slate-400 mb-3">æ ¸å¿ƒç»„ç»‡ (åº¦ä¸­å¿ƒæ€§)</h3>
        <div id="og-centrality"></div>
      </div>
      <div class="card">
        <h3 class="text-sm font-semibold text-slate-400 mb-3">ç»„ç»‡é›†ç¾¤</h3>
        <div id="og-clusters"></div>
      </div>
    </div>
    <div class="card overflow-x-auto">
      <h3 class="text-sm font-semibold text-slate-400 mb-3">å…³ç³»è¾¹</h3>
      <table>
        <thead><tr><th>æº</th><th>ç›®æ ‡</th><th>ç±»å‹</th><th>æƒé‡</th></tr></thead>
        <tbody id="og-tbody"></tbody>
      </table>
    </div>
    <div id="og-loading" class="loading">åŠ è½½ä¸­...</div>
  </div>

  <!-- Search Panel -->
  <div id="panel-search" class="panel">
    <div class="flex gap-3 mb-4 items-center">
      <input id="sr-query" type="text" placeholder="æœç´¢å…³é”®è¯..." class="w-72" onkeydown="if(event.key==='Enter')runSearch()">
      <button onclick="runSearch()" class="tab-btn active" style="padding:0.375rem 1rem">æœç´¢</button>
      <span id="sr-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div id="sr-results" class="space-y-4"></div>
    <div id="sr-loading" class="loading" style="display:none">æœç´¢ä¸­...</div>
  </div>

  <!-- Trends Panel -->
  <div id="panel-trends" class="panel">
    <div class="grid md:grid-cols-2 gap-6">
      <div class="card">
        <h3 class="text-sm font-semibold text-slate-400 mb-3">æ•°æ®æºè¶‹åŠ¿</h3>
        <div style="max-height:400px;"><canvas id="chart-trends"></canvas></div>
      </div>
      <div class="card">
        <h3 class="text-sm font-semibold text-slate-400 mb-3">æ•°æ®é›†åˆ†ç±»åˆ†å¸ƒå˜åŒ–</h3>
        <div style="max-height:400px;"><canvas id="chart-category-trends"></canvas></div>
      </div>
    </div>
    <div id="tr-loading" class="loading">åŠ è½½ä¸­...</div>
  </div>

  <!-- Alerts Panel -->
  <div id="panel-alerts" class="panel">
    <div class="flex gap-3 mb-4">
      <select id="alert-severity" class="bg-card border border-border rounded px-3 py-1.5 text-sm" onchange="loadAlerts()">
        <option value="">å…¨éƒ¨ä¸¥é‡åº¦</option>
        <option value="critical">Critical</option>
        <option value="warning">Warning</option>
        <option value="info">Info</option>
      </select>
    </div>
    <table>
      <thead><tr><th>ä¸¥é‡åº¦</th><th>æ ‡é¢˜</th><th>è§„åˆ™</th><th>è¯¦æƒ…</th><th>æ—¶é—´</th></tr></thead>
      <tbody id="alert-body"></tbody>
    </table>
    <div id="al-loading" class="loading">åŠ è½½ä¸­...</div>
  </div>

</main>

<script>
// ========================================
// State
// ========================================
const API = window.location.origin;
let summaryData = null;
let allDatasets = [];
let allRepos = [];
let dsSortKey = 'downloads', dsSortAsc = false;
let ghSortKey = 'stars', ghSortAsc = false;
let categoryChart = null;
let allRedditPosts = [];
let rdSortKey = 'score', rdSortAsc = false;
let trendChart = null, catTrendChart = null;
let allMatrixRows = [];
let mxSortKey = 'total', mxSortAsc = false;
const loaded = { overview: false, datasets: false, github: false, papers: false, blogs: false, reddit: false, matrix: false, lineage: false, orggraph: false, search: false, trends: false, alerts: false };

// ========================================
// API
// ========================================
async function fetchAPI(path) {
  try {
    const res = await fetch(API + path);
    if (!res.ok) return null;
    return await res.json();
  } catch (e) { console.error('Fetch error:', path, e); return null; }
}

// ========================================
// Tab switching
// ========================================
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach((b, i) => {
    b.classList.toggle('active', ['overview','datasets','github','papers','blogs','reddit','matrix','lineage','orggraph','search','trends','alerts'][i] === name);
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  if (!loaded[name]) {
    loaded[name] = true;
    if (name === 'overview') loadOverview();
    else if (name === 'datasets') loadDatasets();
    else if (name === 'github') loadGithub();
    else if (name === 'papers') loadPapers();
    else if (name === 'blogs') loadBlogs();
    else if (name === 'reddit') loadReddit();
    else if (name === 'matrix') loadMatrix();
    else if (name === 'lineage') loadLineage();
    else if (name === 'orggraph') loadOrgGraph();
    else if (name === 'search') { /* search is on-demand */ loaded.search = true; }
    else if (name === 'trends') loadTrends();
    else if (name === 'alerts') loadAlerts();
  }
}

// ========================================
// Health check
// ========================================
async function checkHealth() {
  const data = await fetchAPI('/health');
  const dot = document.getElementById('health-dot');
  if (data && data.status === 'ok') {
    dot.className = 'w-2.5 h-2.5 rounded-full bg-green-500 inline-block';
    if (data.report_generated_at) {
      const t = new Date(data.report_generated_at);
      document.getElementById('scan-time').textContent = 'æœ€è¿‘æ‰«æ: ' + t.toLocaleString('zh-CN');
    }
  } else {
    dot.className = 'w-2.5 h-2.5 rounded-full bg-red-500 inline-block';
  }
}

// ========================================
// Overview
// ========================================
async function loadOverview() {
  const data = await fetchAPI('/summary');
  if (!data || !data.summary) {
    document.getElementById('panel-overview').innerHTML = '<div class="loading">æš‚æ— æŠ¥å‘Šæ•°æ®ã€‚è¯·å…ˆè¿è¡Œæ‰«æï¼š<code>POST /scan</code></div>';
    return;
  }
  summaryData = data;
  const s = data.summary;
  document.getElementById('m-datasets').textContent = s.total_datasets || 0;
  document.getElementById('m-repos').textContent = s.total_github_repos || 0;
  document.getElementById('m-papers').textContent = s.total_papers || 0;
  document.getElementById('m-blogs').textContent = s.total_blog_posts || 0;
  document.getElementById('m-reddit').textContent = s.total_reddit_posts || 0;

  // Load datasets for chart + top 10
  const dsData = await fetchAPI('/datasets?limit=500');
  if (dsData && dsData.datasets) {
    renderCategoryChart(dsData.datasets);
    renderTopDatasets(dsData.datasets);
  }
}

function renderCategoryChart(datasets) {
  const counts = {};
  datasets.forEach(d => {
    const cat = d.category || 'other';
    counts[cat] = (counts[cat] || 0) + 1;
  });
  const labels = Object.keys(counts);
  const values = Object.values(counts);
  const colors = ['#38bdf8','#a78bfa','#f472b6','#fb923c','#4ade80','#fbbf24','#f87171','#94a3b8','#2dd4bf','#818cf8'];

  const ctx = document.getElementById('chart-categories').getContext('2d');
  if (categoryChart) categoryChart.destroy();
  categoryChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels.map(l => l.replace(/_/g, ' ')),
      datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }]
    },
    options: {
      responsive: true, maintainAspectRatio: true,
      plugins: {
        legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 11 }, padding: 8, boxWidth: 12 } }
      },
      cutout: '55%'
    }
  });
}

function renderTopDatasets(datasets) {
  const sorted = [...datasets].sort((a, b) => (b.downloads || 0) - (a.downloads || 0)).slice(0, 10);
  const tbody = document.getElementById('top-datasets');
  tbody.innerHTML = sorted.map(d => `<tr>
    <td><a href="https://huggingface.co/datasets/${esc(d.id)}" target="_blank">${esc(d.id) || '-'}</a></td>
    <td><span class="badge badge-blue">${esc((d.category || 'other').replace(/_/g, ' '))}</span></td>
    <td>${fmtNum(d.downloads)}</td>
  </tr>`).join('');
}

// ========================================
// Datasets
// ========================================
async function loadDatasets() {
  const el = document.getElementById('ds-loading');
  el.style.display = 'block';
  const cat = document.getElementById('ds-category').value;
  const q = cat ? `?category=${cat}&limit=500` : '?limit=500';
  const data = await fetchAPI('/datasets' + q);
  el.style.display = 'none';
  if (!data) return;
  allDatasets = data.datasets || [];
  renderDatasets();
}

function filterDatasets() {
  renderDatasets();
}

function sortDatasets(key) {
  if (dsSortKey === key) dsSortAsc = !dsSortAsc;
  else { dsSortKey = key; dsSortAsc = false; }
  renderDatasets();
}

function renderDatasets() {
  const search = (document.getElementById('ds-search').value || '').toLowerCase();
  let ds = allDatasets;
  if (search) ds = ds.filter(d => (d.id || '').toLowerCase().includes(search) || (d.author || '').toLowerCase().includes(search) || (d.description || '').toLowerCase().includes(search));

  ds = [...ds].sort((a, b) => {
    let va = a[dsSortKey] ?? '', vb = b[dsSortKey] ?? '';
    if (typeof va === 'number') return dsSortAsc ? va - vb : vb - va;
    return dsSortAsc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
  });

  document.getElementById('ds-count').textContent = `å…± ${ds.length} ä¸ªæ•°æ®é›†`;
  const tbody = document.getElementById('ds-tbody');
  tbody.innerHTML = ds.slice(0, 200).map(d => `<tr>
    <td><a href="https://huggingface.co/datasets/${esc(d.id)}" target="_blank">${esc(d.id) || '-'}</a></td>
    <td>${esc(d.author) || '-'}</td>
    <td><span class="badge badge-blue">${esc((d.category || 'other').replace(/_/g, ' '))}</span></td>
    <td>${fmtNum(d.downloads)}</td>
    <td>${fmtNum(d.likes)}</td>
    <td>${esc((d.languages || []).join(', ')) || '-'}</td>
    <td class="text-xs">${esc(Array.isArray(d.license) ? d.license[0] : (d.license || '-'))}</td>
  </tr>`).join('');
}

// ========================================
// GitHub
// ========================================
async function loadGithub() {
  const el = document.getElementById('gh-loading');
  el.style.display = 'block';
  const rel = document.getElementById('gh-relevance').value;
  const data = await fetchAPI(`/github?relevance=${rel}&limit=500`);
  el.style.display = 'none';
  if (!data) return;
  allRepos = data.repos || [];
  renderGithub();
}

function sortGithub(key) {
  if (ghSortKey === key) ghSortAsc = !ghSortAsc;
  else { ghSortKey = key; ghSortAsc = false; }
  renderGithub();
}

function renderGithub() {
  let repos = [...allRepos].sort((a, b) => {
    let va = a[ghSortKey] ?? '', vb = b[ghSortKey] ?? '';
    if (typeof va === 'number') return ghSortAsc ? va - vb : vb - va;
    return ghSortAsc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
  });

  document.getElementById('gh-count').textContent = `å…± ${repos.length} ä¸ªä»“åº“`;
  const tbody = document.getElementById('gh-tbody');
  if (repos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-slate-500 py-6">æ— åŒ¹é…ä»“åº“</td></tr>';
    return;
  }
  tbody.innerHTML = repos.slice(0, 200).map(r => `<tr>
    <td><a href="${esc(r.url) || '#'}" target="_blank">${esc(r.full_name || r.name) || '-'}</a></td>
    <td>${fmtNum(r.stars)}</td>
    <td>${esc(r.language) || '-'}</td>
    <td class="text-xs">${esc(r.updated_at) || '-'}</td>
    <td>${(r.relevance_signals || r.signals || []).slice(0, 3).map(s => `<span class="badge badge-green">${esc(s)}</span>`).join(' ')}</td>
  </tr>`).join('');
}

// ========================================
// Papers
// ========================================
async function loadPapers() {
  const el = document.getElementById('pp-loading');
  el.style.display = 'block';
  const src = document.getElementById('pp-source').value;
  const dsOnly = document.getElementById('pp-dataset').checked;
  const data = await fetchAPI(`/papers?source=${src}&dataset_only=${dsOnly}&limit=200`);
  el.style.display = 'none';
  if (!data) return;
  const papers = data.papers || [];
  document.getElementById('pp-count').textContent = `å…± ${papers.length} ç¯‡è®ºæ–‡`;

  document.getElementById('pp-list').innerHTML = papers.map(p => {
    const srcBadge = p.source === 'arxiv'
      ? '<span class="badge badge-orange">arXiv</span>'
      : '<span class="badge badge-purple">HuggingFace</span>';
    const authors = Array.isArray(p.authors) ? p.authors.slice(0, 3).join(', ') : (p.authors || '');
    return `<div class="card">
      <div class="flex items-start justify-between gap-4">
        <div>
          <a href="${esc(p.url || p.pdf_url) || '#'}" target="_blank" class="font-medium">${esc(p.title) || '-'}</a>
          <div class="text-xs text-slate-500 mt-1">${esc(authors)}${p.authors && p.authors.length > 3 ? ' ...' : ''}</div>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          ${srcBadge}
          <span class="text-xs text-slate-500">${esc(p.created_at || p.published_at) || ''}</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

// ========================================
// Blogs
// ========================================
async function loadBlogs() {
  const el = document.getElementById('bl-loading');
  el.style.display = 'block';
  const cat = document.getElementById('bl-category').value;
  const data = await fetchAPI(`/blogs?category=${cat}&limit=500`);
  el.style.display = 'none';
  if (!data) return;

  const articles = data.articles || [];
  // Group by source
  const groups = {};
  articles.forEach(a => {
    const src = a.source || 'æœªçŸ¥';
    if (!groups[src]) groups[src] = [];
    groups[src].push(a);
  });

  const totalSources = Object.keys(groups).length;
  document.getElementById('bl-count').textContent = `å…± ${articles.length} ç¯‡æ–‡ç« ï¼Œæ¥è‡ª ${totalSources} ä¸ªæ¥æº`;

  const listEl = document.getElementById('bl-list');
  if (articles.length === 0) {
    listEl.innerHTML = '<div class="card text-center text-slate-500 py-8">æœ¬æ¬¡æ‰«ææœªå‘ç°æ–°åšå®¢æ–‡ç« </div>';
    return;
  }
  listEl.innerHTML = Object.entries(groups).map(([src, arts], idx) => `
    <div class="blog-group">
      <div class="blog-header" onclick="this.nextElementSibling.classList.toggle('open')">
        <div class="flex items-center gap-2">
          <span class="font-medium text-sm">${esc(src)}</span>
          ${arts[0].category ? `<span class="badge badge-blue">${esc(arts[0].category)}</span>` : ''}
          <span class="badge badge-gray">${arts.length} ç¯‡</span>
        </div>
        <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </div>
      <div class="blog-body${idx < 3 ? ' open' : ''}">
        ${arts.map(a => `<div class="py-2 border-t border-border/50">
          <a href="${esc(a.url) || '#'}" target="_blank" class="text-sm">${esc(a.title) || '-'}</a>
          <div class="text-xs text-slate-500 mt-0.5">${esc(a.date || a.published_at) || ''}</div>
          ${a.summary ? `<div class="text-xs text-slate-400 mt-1">${esc(a.summary.slice(0, 150))}</div>` : ''}
        </div>`).join('')}
      </div>
    </div>
  `).join('');
}

// ========================================
// Reddit
// ========================================
async function loadReddit() {
  const el = document.getElementById('rd-loading');
  el.style.display = 'block';
  const sub = document.getElementById('rd-subreddit').value;
  const minScore = parseInt(document.getElementById('rd-min-score').value) || 0;
  let q = `?limit=200&min_score=${minScore}`;
  if (sub) q += `&subreddit=${encodeURIComponent(sub)}`;
  const data = await fetchAPI('/reddit' + q);
  el.style.display = 'none';
  if (!data) return;
  allRedditPosts = data.posts || [];

  // Populate subreddit filter dropdown
  const sel = document.getElementById('rd-subreddit');
  const current = sel.value;
  const subs = [...new Set(allRedditPosts.map(p => p.subreddit))].sort();
  sel.innerHTML = '<option value="">å…¨éƒ¨å­ç‰ˆ</option>' + subs.map(s => `<option value="${esc(s)}"${s === current ? ' selected' : ''}>${esc(s)}</option>`).join('');

  renderReddit();
}

function sortReddit(key) {
  if (rdSortKey === key) rdSortAsc = !rdSortAsc;
  else { rdSortKey = key; rdSortAsc = false; }
  renderReddit();
}

function renderReddit() {
  const sub = document.getElementById('rd-subreddit').value;
  let posts = allRedditPosts;
  if (sub) posts = posts.filter(p => p.subreddit === sub);

  posts = [...posts].sort((a, b) => {
    let va = a[rdSortKey] ?? '', vb = b[rdSortKey] ?? '';
    if (typeof va === 'number') return rdSortAsc ? va - vb : vb - va;
    return rdSortAsc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
  });

  document.getElementById('rd-count').textContent = `å…± ${posts.length} ä¸ªå¸–å­`;
  const tbody = document.getElementById('rd-tbody');
  if (posts.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-slate-500 py-6">æ— åŒ¹é…å¸–å­</td></tr>';
    return;
  }
  tbody.innerHTML = posts.slice(0, 200).map(p => `<tr>
    <td class="font-mono">${p.score || 0}</td>
    <td><a href="${esc(p.url) || '#'}" target="_blank">${esc(p.title) || '-'}</a></td>
    <td><span class="badge badge-purple">${esc(p.subreddit)}</span></td>
    <td>${p.num_comments || 0}</td>
    <td>${(p.signals || []).slice(0, 3).map(s => `<span class="badge badge-green">${esc(s)}</span>`).join(' ')}</td>
    <td class="text-xs">${esc(p.author) || '-'}</td>
  </tr>`).join('');
}

// ========================================
// Competitor Matrix
// ========================================
async function loadMatrix() {
  const el = document.getElementById('mx-loading');
  el.style.display = 'block';
  const data = await fetchAPI('/matrix');
  el.style.display = 'none';
  if (!data) return;

  const topOrgs = data.top_orgs || [];
  const details = data.org_details || {};
  allMatrixRows = topOrgs.map(([org, total]) => {
    const d = details[org] || {};
    return { org, datasets: d.datasets || 0, repos: d.repos || 0, papers: d.papers || 0, blogs: d.blogs || 0, total };
  });
  renderMatrix();
}

function sortMatrix(key) {
  if (mxSortKey === key) mxSortAsc = !mxSortAsc;
  else { mxSortKey = key; mxSortAsc = false; }
  renderMatrix();
}

function renderMatrix() {
  let rows = [...allMatrixRows].sort((a, b) => {
    let va = a[mxSortKey] ?? '', vb = b[mxSortKey] ?? '';
    if (typeof va === 'number') return mxSortAsc ? va - vb : vb - va;
    return mxSortAsc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
  });
  document.getElementById('mx-count').textContent = `å…± ${rows.length} ä¸ªç»„ç»‡`;
  const tbody = document.getElementById('mx-tbody');
  if (!rows.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-slate-500 py-6">æ— æ•°æ®</td></tr>'; return; }
  tbody.innerHTML = rows.slice(0, 100).map(r => `<tr>
    <td class="font-medium">${esc(r.org)}</td>
    <td>${r.datasets}</td><td>${r.repos}</td><td>${r.papers}</td><td>${r.blogs}</td>
    <td class="font-mono font-bold">${r.total}</td>
  </tr>`).join('');
}

// ========================================
// Dataset Lineage
// ========================================
async function loadLineage() {
  const el = document.getElementById('ln-loading');
  el.style.display = 'block';
  const data = await fetchAPI('/lineage');
  el.style.display = 'none';
  if (!data) return;

  const stats = data.stats || {};
  document.getElementById('ln-edges').textContent = stats.derivation_edges || 0;
  document.getElementById('ln-chains').textContent = stats.version_chains || 0;
  document.getElementById('ln-forks').textContent = stats.fork_groups || 0;
  document.getElementById('ln-count').textContent = `åˆ†æ ${stats.total_datasets || 0} ä¸ªæ•°æ®é›†`;

  const sections = [];

  // Version chains
  const chains = data.version_chains || {};
  if (Object.keys(chains).length) {
    sections.push(`<div class="card"><h3 class="text-sm font-semibold text-slate-400 mb-2">ç‰ˆæœ¬é“¾</h3>
      ${Object.entries(chains).slice(0, 20).map(([base, chain]) =>
        `<div class="py-1 border-t border-border/50 text-sm"><span class="font-medium">${esc(base)}</span>: ${chain.map(c => esc(c)).join(' â†’ ')}</div>`
      ).join('')}</div>`);
  }

  // Fork trees
  const forks = data.fork_trees || {};
  if (Object.keys(forks).length) {
    sections.push(`<div class="card"><h3 class="text-sm font-semibold text-slate-400 mb-2">Fork åˆ†æ”¯</h3>
      ${Object.entries(forks).slice(0, 20).map(([name, ids]) =>
        `<div class="py-1 border-t border-border/50 text-sm"><span class="font-medium">${esc(name)}</span>: ${ids.map(id => esc(id)).join(', ')}</div>`
      ).join('')}</div>`);
  }

  // Derivation edges
  const edges = data.edges || [];
  const derivations = edges.filter(e => (e.type || e[2]) === 'derived_from');
  if (derivations.length) {
    sections.push(`<div class="card"><h3 class="text-sm font-semibold text-slate-400 mb-2">æ´¾ç”Ÿå…³ç³» (${derivations.length})</h3>
      <table><thead><tr><th>å­æ•°æ®é›†</th><th>â†</th><th>çˆ¶æ•°æ®é›†</th></tr></thead><tbody>
      ${derivations.slice(0, 50).map(e => `<tr><td class="text-sm">${esc(e.child || e[0])}</td><td class="text-slate-500">derived from</td><td class="text-sm">${esc(e.parent || e[1])}</td></tr>`).join('')}
      </tbody></table></div>`);
  }

  document.getElementById('ln-sections').innerHTML = sections.length ? sections.join('') : '<div class="card text-center text-slate-500 py-8">æœªå‘ç°è°±ç³»å…³ç³»</div>';
}

// ========================================
// Org Graph
// ========================================
async function loadOrgGraph() {
  const el = document.getElementById('og-loading');
  el.style.display = 'block';
  const data = await fetchAPI('/org-graph');
  el.style.display = 'none';
  if (!data) return;

  const nodes = data.nodes || [];
  const edges = data.edges || [];
  document.getElementById('og-count').textContent = `${nodes.length} ä¸ªèŠ‚ç‚¹ï¼Œ${edges.length} æ¡è¾¹`;

  // Centrality
  const centrality = data.centrality || {};
  const topCentral = Object.entries(centrality).sort((a, b) => b[1] - a[1]).filter(x => x[1] > 0).slice(0, 15);
  document.getElementById('og-centrality').innerHTML = topCentral.length
    ? topCentral.map(([org, score]) => {
        const pct = Math.min(score * 100 / (topCentral[0][1] || 1) * topCentral[0][1], 100);
        return `<div class="flex items-center gap-2 py-1 text-sm">
          <span class="w-24 truncate">${esc(org)}</span>
          <div class="flex-1 bg-bg rounded h-2"><div class="bg-accent rounded h-2" style="width:${Math.max(pct, 4)}%"></div></div>
          <span class="text-xs text-slate-500 w-12 text-right">${score.toFixed(3)}</span>
        </div>`;
      }).join('')
    : '<div class="text-slate-500 text-sm py-4">æ— æ•°æ®</div>';

  // Clusters
  const clusters = data.clusters || [];
  document.getElementById('og-clusters').innerHTML = clusters.length
    ? clusters.filter(c => c.length >= 2).slice(0, 10).map((cluster, i) =>
        `<div class="py-1.5 border-t border-border/50 text-sm">
          <span class="badge badge-purple">é›†ç¾¤ ${i + 1}</span>
          <span class="ml-2">${cluster.slice(0, 8).map(o => esc(o)).join(', ')}${cluster.length > 8 ? '...' : ''}</span>
          <span class="text-xs text-slate-500 ml-1">(${cluster.length})</span>
        </div>`
      ).join('')
    : '<div class="text-slate-500 text-sm py-4">æ— æ•°æ®</div>';

  // Edges table
  const tbody = document.getElementById('og-tbody');
  if (!edges.length) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-slate-500 py-6">æ— å…³ç³»æ•°æ®</td></tr>';
    return;
  }
  const typeBadge = {
    'shared_dataset_author': 'badge-blue',
    'github_fork': 'badge-green',
    'co_citation': 'badge-purple',
    'blog_mention': 'badge-orange',
    'shared_topic': 'badge-gray',
  };
  tbody.innerHTML = edges.slice(0, 50).map(e => `<tr>
    <td class="text-sm">${esc(e.source)}</td>
    <td class="text-sm">${esc(e.target)}</td>
    <td><span class="badge ${typeBadge[e.type] || 'badge-gray'}">${esc(e.type)}</span></td>
    <td class="font-mono">${e.weight}</td>
  </tr>`).join('');
}

// ========================================
// Search
// ========================================
async function runSearch() {
  const q = document.getElementById('sr-query').value.trim();
  if (!q) return;
  const el = document.getElementById('sr-loading');
  el.style.display = 'block';
  const data = await fetchAPI(`/search?q=${encodeURIComponent(q)}&limit=20`);
  el.style.display = 'none';
  if (!data) return;

  const results = data.results || {};
  document.getElementById('sr-count').textContent = `å…± ${data.total || 0} æ¡ç»“æœ`;

  const sections = [];
  if (results.datasets && results.datasets.length) {
    sections.push(`<div class="card"><h3 class="text-sm font-semibold text-slate-400 mb-2">æ•°æ®é›† (${results.datasets.length})</h3>
      ${results.datasets.map(d => `<div class="py-1 border-t border-border/50"><a href="https://huggingface.co/datasets/${esc(d.id)}" target="_blank" class="text-sm">${esc(d.id)}</a> <span class="badge badge-blue">${esc(d.category || '')}</span></div>`).join('')}
    </div>`);
  }
  if (results.github && results.github.length) {
    sections.push(`<div class="card"><h3 class="text-sm font-semibold text-slate-400 mb-2">GitHub (${results.github.length})</h3>
      ${results.github.map(r => `<div class="py-1 border-t border-border/50"><a href="${esc(r.url) || '#'}" target="_blank" class="text-sm">${esc(r.full_name || r.name)}</a> <span class="text-xs text-slate-500">â˜…${r.stars || 0}</span></div>`).join('')}
    </div>`);
  }
  if (results.papers && results.papers.length) {
    sections.push(`<div class="card"><h3 class="text-sm font-semibold text-slate-400 mb-2">è®ºæ–‡ (${results.papers.length})</h3>
      ${results.papers.map(p => `<div class="py-1 border-t border-border/50"><a href="${esc(p.url || p.pdf_url) || '#'}" target="_blank" class="text-sm">${esc(p.title)}</a></div>`).join('')}
    </div>`);
  }
  if (results.blogs && results.blogs.length) {
    sections.push(`<div class="card"><h3 class="text-sm font-semibold text-slate-400 mb-2">åšå®¢ (${results.blogs.length})</h3>
      ${results.blogs.map(a => `<div class="py-1 border-t border-border/50"><a href="${esc(a.url) || '#'}" target="_blank" class="text-sm">${esc(a.title)}</a> <span class="text-xs text-slate-500">${esc(a.source || '')}</span></div>`).join('')}
    </div>`);
  }
  if (results.reddit && results.reddit.length) {
    sections.push(`<div class="card"><h3 class="text-sm font-semibold text-slate-400 mb-2">Reddit (${results.reddit.length})</h3>
      ${results.reddit.map(p => `<div class="py-1 border-t border-border/50"><a href="${esc(p.url) || '#'}" target="_blank" class="text-sm">${esc(p.title)}</a> <span class="badge badge-purple">${esc(p.subreddit || '')}</span></div>`).join('')}
    </div>`);
  }
  document.getElementById('sr-results').innerHTML = sections.length ? sections.join('') : '<div class="card text-center text-slate-500 py-8">æ— åŒ¹é…ç»“æœ</div>';
}

// ========================================
// Trends
// ========================================
async function loadTrends() {
  const el = document.getElementById('tr-loading');
  el.style.display = 'block';
  const data = await fetchAPI('/trends?limit=30');
  el.style.display = 'none';
  if (!data || !data.timeline || data.timeline.length === 0) {
    document.getElementById('panel-trends').innerHTML = '<div class="loading">æš‚æ— å†å²è¶‹åŠ¿æ•°æ®ã€‚è‡³å°‘éœ€è¦ 2 æ¬¡æ‰«æè®°å½•ã€‚</div>';
    return;
  }

  const timeline = data.timeline;
  const dates = timeline.map(t => t.date);
  const trendColors = ['#38bdf8', '#a78bfa', '#f472b6', '#fb923c', '#4ade80'];

  // Source trends line chart
  const ctx1 = document.getElementById('chart-trends').getContext('2d');
  if (trendChart) trendChart.destroy();
  trendChart = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [
        { label: 'æ•°æ®é›†', data: timeline.map(t => t.datasets), borderColor: trendColors[0], backgroundColor: trendColors[0] + '33', fill: true, tension: 0.3 },
        { label: 'ä»“åº“', data: timeline.map(t => t.repos), borderColor: trendColors[1], fill: false, tension: 0.3 },
        { label: 'è®ºæ–‡', data: timeline.map(t => t.papers), borderColor: trendColors[2], fill: false, tension: 0.3 },
        { label: 'åšå®¢', data: timeline.map(t => t.blogs), borderColor: trendColors[3], fill: false, tension: 0.3 },
        { label: 'Reddit', data: timeline.map(t => t.reddit), borderColor: trendColors[4], fill: false, tension: 0.3 },
      ],
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#94a3b8', font: { size: 11 } } } },
      scales: {
        x: { ticks: { color: '#64748b', maxRotation: 45 }, grid: { color: '#1e293b' } },
        y: { ticks: { color: '#64748b' }, grid: { color: '#1e293b' } },
      },
    },
  });

  // Category distribution bar chart
  const catData = data.datasets_by_category || {};
  const catLabels = Object.keys(catData);
  if (catLabels.length && dates.length) {
    const ctx2 = document.getElementById('chart-category-trends').getContext('2d');
    if (catTrendChart) catTrendChart.destroy();
    const chartColors = ['#38bdf8','#a78bfa','#f472b6','#fb923c','#4ade80','#fbbf24','#f87171','#94a3b8','#2dd4bf','#818cf8','#e879f9'];
    catTrendChart = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: dates,
        datasets: catLabels.map((cat, i) => ({
          label: cat.replace(/_/g, ' '),
          data: dates.map(d => (catData[cat] || {})[d] || 0),
          backgroundColor: chartColors[i % chartColors.length] + 'cc',
        })),
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: '#94a3b8', font: { size: 10 } } } },
        scales: {
          x: { stacked: true, ticks: { color: '#64748b', maxRotation: 45 }, grid: { color: '#1e293b' } },
          y: { stacked: true, ticks: { color: '#64748b' }, grid: { color: '#1e293b' } },
        },
      },
    });
  }
}

// ========================================
// Alerts
// ========================================
async function loadAlerts() {
  const sev = document.getElementById('alert-severity').value;
  const params = sev ? `?limit=100&severity=${sev}` : '?limit=100';
  const data = await fetchAPI('/alerts' + params);
  document.getElementById('al-loading').style.display = 'none';
  if (!data || !data.alerts || data.alerts.length === 0) {
    document.getElementById('alert-body').innerHTML = '<tr><td colspan="5" class="text-center text-slate-500 py-8">æš‚æ— å‘Šè­¦è®°å½•</td></tr>';
    return;
  }
  const icons = { critical: 'ğŸ”´', warning: 'ğŸŸ¡', info: 'ğŸ”µ' };
  document.getElementById('alert-body').innerHTML = data.alerts.map(a => `<tr>
    <td>${icons[a.severity] || 'âšª'} <span class="font-semibold">${esc(a.severity?.toUpperCase())}</span></td>
    <td>${esc(a.title)}</td>
    <td><code class="text-xs bg-card px-1.5 py-0.5 rounded">${esc(a.rule)}</code></td>
    <td class="text-slate-400 text-xs">${esc(a.detail)}</td>
    <td class="text-xs text-slate-500 whitespace-nowrap">${esc(a.timestamp?.slice(0, 19))}</td>
  </tr>`).join('');
  loaded.alerts = true;
}

// ========================================
// Helpers
// ========================================
function esc(s) {
  if (s == null) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

function fmtNum(n) {
  if (n == null) return '-';
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return String(n);
}

// ========================================
// Init
// ========================================
checkHealth();
loaded.overview = true;
loadOverview();
</script>
</body>
</html>
