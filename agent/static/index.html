<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Dataset Radar</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>tailwind.config={theme:{extend:{colors:{bg:'#0f172a',card:'#1e293b',border:'#334155',accent:'#38bdf8'}}}}</script>
<style>
  body { background: #0f172a; color: #e2e8f0; font-family: system-ui, sans-serif; }
  .tab-btn { padding: 0.5rem 1.25rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; }
  .tab-btn.active { background: #38bdf8; color: #0f172a; font-weight: 600; }
  .tab-btn:not(.active):hover { background: #1e293b; }
  table { width: 100%; border-collapse: collapse; }
  th { cursor: pointer; user-select: none; text-align: left; padding: 0.625rem 0.75rem; color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #334155; }
  th:hover { color: #e2e8f0; }
  td { padding: 0.625rem 0.75rem; border-bottom: 1px solid #1e293b; font-size: 0.875rem; }
  tr:hover td { background: #1e293b; }
  a { color: #38bdf8; text-decoration: none; }
  a:hover { text-decoration: underline; }
  .badge { display: inline-block; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 500; }
  .badge-blue { background: #1e3a5f; color: #7dd3fc; }
  .badge-green { background: #14532d; color: #86efac; }
  .badge-purple { background: #3b0764; color: #d8b4fe; }
  .badge-orange { background: #431407; color: #fdba74; }
  .badge-gray { background: #1e293b; color: #94a3b8; }
  .card { background: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; padding: 1.25rem; }
  .metric { font-size: 2rem; font-weight: 700; color: #f1f5f9; }
  .metric-label { font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem; }
  select, input[type=text] { background: #1e293b; border: 1px solid #334155; color: #e2e8f0; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; }
  select:focus, input:focus { outline: none; border-color: #38bdf8; }
  .loading { text-align: center; padding: 3rem; color: #64748b; }
  .panel { display: none; }
  .panel.active { display: block; }
  .blog-group { border: 1px solid #334155; border-radius: 0.5rem; margin-bottom: 0.5rem; }
  .blog-header { padding: 0.75rem 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .blog-header:hover { background: #1e293b; }
  .blog-body { display: none; padding: 0 1rem 0.75rem; }
  .blog-body.open { display: block; }
</style>
</head>
<body class="min-h-screen">

<!-- Header -->
<header class="border-b border-border px-6 py-4 flex items-center justify-between">
  <div class="flex items-center gap-3">
    <div class="text-xl font-bold text-accent">AI Dataset Radar</div>
    <div class="text-sm text-slate-500">竞争情报仪表盘</div>
  </div>
  <div class="flex items-center gap-3">
    <span id="scan-time" class="text-xs text-slate-500"></span>
    <span id="health-dot" class="w-2.5 h-2.5 rounded-full bg-slate-600 inline-block"></span>
  </div>
</header>

<!-- Tabs -->
<nav class="px-6 py-3 flex gap-2 border-b border-border">
  <button class="tab-btn active" onclick="switchTab('overview')">概览</button>
  <button class="tab-btn" onclick="switchTab('datasets')">数据集</button>
  <button class="tab-btn" onclick="switchTab('github')">GitHub</button>
  <button class="tab-btn" onclick="switchTab('papers')">论文</button>
  <button class="tab-btn" onclick="switchTab('blogs')">博客</button>
  <button class="tab-btn" onclick="switchTab('reddit')">Reddit</button>
  <button class="tab-btn" onclick="switchTab('search')">搜索</button>
  <button class="tab-btn" onclick="switchTab('trends')">趋势</button>
</nav>

<!-- Content -->
<main class="px-6 py-5 max-w-[1400px] mx-auto">

  <!-- Overview Panel -->
  <div id="panel-overview" class="panel active">
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
      <div class="card"><div class="metric" id="m-datasets">-</div><div class="metric-label">数据集</div></div>
      <div class="card"><div class="metric" id="m-repos">-</div><div class="metric-label">GitHub 仓库</div></div>
      <div class="card"><div class="metric" id="m-papers">-</div><div class="metric-label">论文</div></div>
      <div class="card"><div class="metric" id="m-blogs">-</div><div class="metric-label">博客文章</div></div>
      <div class="card"><div class="metric" id="m-reddit">-</div><div class="metric-label">Reddit 帖子</div></div>
    </div>
    <div class="grid md:grid-cols-2 gap-6">
      <div class="card">
        <h3 class="text-sm font-semibold text-slate-400 mb-3">数据集分类分布</h3>
        <div style="max-height:320px;display:flex;justify-content:center;"><canvas id="chart-categories"></canvas></div>
      </div>
      <div class="card">
        <h3 class="text-sm font-semibold text-slate-400 mb-3">热门数据集 Top 10</h3>
        <table>
          <thead><tr><th>数据集</th><th>类别</th><th>下载量</th></tr></thead>
          <tbody id="top-datasets"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Datasets Panel -->
  <div id="panel-datasets" class="panel">
    <div class="flex gap-3 mb-4 flex-wrap items-center">
      <select id="ds-category" onchange="loadDatasets()">
        <option value="">全部类别</option>
        <option value="sft_instruction">SFT / Instruction</option>
        <option value="rlhf_preference">RLHF / Preference</option>
        <option value="reward_model">Reward Model</option>
        <option value="synthetic">Synthetic</option>
        <option value="agent_tool">Agent / Tool Use</option>
        <option value="multimodal">Multimodal</option>
        <option value="multilingual">Multilingual</option>
        <option value="rl_environment">RL / Embodied</option>
        <option value="code">Code</option>
        <option value="evaluation">Evaluation</option>
        <option value="other">Other</option>
      </select>
      <input id="ds-search" type="text" placeholder="搜索数据集..." oninput="filterDatasets()" class="w-56">
      <span id="ds-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div class="card overflow-x-auto">
      <table>
        <thead><tr>
          <th onclick="sortDatasets('id')">ID</th>
          <th onclick="sortDatasets('author')">作者</th>
          <th onclick="sortDatasets('category')">类别</th>
          <th onclick="sortDatasets('downloads')">下载量</th>
          <th onclick="sortDatasets('likes')">点赞</th>
          <th>语言</th>
          <th>许可证</th>
        </tr></thead>
        <tbody id="ds-tbody"></tbody>
      </table>
      <div id="ds-loading" class="loading">加载中...</div>
    </div>
  </div>

  <!-- GitHub Panel -->
  <div id="panel-github" class="panel">
    <div class="flex gap-3 mb-4 items-center">
      <select id="gh-relevance" onchange="loadGithub()">
        <option value="all">全部相关性</option>
        <option value="high" selected>高相关</option>
        <option value="low">低相关</option>
      </select>
      <span id="gh-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div class="card overflow-x-auto">
      <table>
        <thead><tr>
          <th onclick="sortGithub('full_name')">仓库</th>
          <th onclick="sortGithub('stars')">Stars</th>
          <th>语言</th>
          <th>更新时间</th>
          <th>相关信号</th>
        </tr></thead>
        <tbody id="gh-tbody"></tbody>
      </table>
      <div id="gh-loading" class="loading">加载中...</div>
    </div>
  </div>

  <!-- Papers Panel -->
  <div id="panel-papers" class="panel">
    <div class="flex gap-3 mb-4 items-center">
      <select id="pp-source" onchange="loadPapers()">
        <option value="all">全部来源</option>
        <option value="arxiv">arXiv</option>
        <option value="huggingface">HuggingFace</option>
      </select>
      <label class="flex items-center gap-1 text-xs text-slate-400 cursor-pointer"><input type="checkbox" id="pp-dataset" onchange="loadPapers()"> 仅数据集论文</label>
      <span id="pp-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div id="pp-list" class="space-y-3"></div>
    <div id="pp-loading" class="loading">加载中...</div>
  </div>

  <!-- Blogs Panel -->
  <div id="panel-blogs" class="panel">
    <div class="flex gap-3 mb-4 items-center">
      <select id="bl-category" onchange="loadBlogs()">
        <option value="all">全部分类</option>
        <option value="us_frontier">US Frontier</option>
        <option value="us_emerging">US Emerging</option>
        <option value="china">China</option>
        <option value="research">Research</option>
        <option value="data_vendor">Data Vendor</option>
      </select>
      <span id="bl-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div id="bl-list" class="space-y-2"></div>
    <div id="bl-loading" class="loading">加载中...</div>
  </div>

  <!-- Reddit Panel -->
  <div id="panel-reddit" class="panel">
    <div class="flex gap-3 mb-4 items-center">
      <select id="rd-subreddit" onchange="loadReddit()">
        <option value="">全部子版</option>
      </select>
      <input id="rd-min-score" type="text" placeholder="最低分数" class="w-28" value="5" onchange="loadReddit()">
      <span id="rd-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div class="card overflow-x-auto">
      <table>
        <thead><tr>
          <th onclick="sortReddit('score')">分数</th>
          <th onclick="sortReddit('title')">标题</th>
          <th onclick="sortReddit('subreddit')">子版</th>
          <th onclick="sortReddit('num_comments')">评论</th>
          <th>信号</th>
          <th>作者</th>
        </tr></thead>
        <tbody id="rd-tbody"></tbody>
      </table>
      <div id="rd-loading" class="loading">加载中...</div>
    </div>
  </div>

  <!-- Search Panel -->
  <div id="panel-search" class="panel">
    <div class="flex gap-3 mb-4 items-center">
      <input id="sr-query" type="text" placeholder="搜索关键词..." class="w-72" onkeydown="if(event.key==='Enter')runSearch()">
      <button onclick="runSearch()" class="tab-btn active" style="padding:0.375rem 1rem">搜索</button>
      <span id="sr-count" class="text-xs text-slate-500 ml-auto"></span>
    </div>
    <div id="sr-results" class="space-y-4"></div>
    <div id="sr-loading" class="loading" style="display:none">搜索中...</div>
  </div>

  <!-- Trends Panel -->
  <div id="panel-trends" class="panel">
    <div class="grid md:grid-cols-2 gap-6">
      <div class="card">
        <h3 class="text-sm font-semibold text-slate-400 mb-3">数据源趋势</h3>
        <div style="max-height:400px;"><canvas id="chart-trends"></canvas></div>
      </div>
      <div class="card">
        <h3 class="text-sm font-semibold text-slate-400 mb-3">数据集分类分布变化</h3>
        <div style="max-height:400px;"><canvas id="chart-category-trends"></canvas></div>
      </div>
    </div>
    <div id="tr-loading" class="loading">加载中...</div>
  </div>

</main>

<script>
// ========================================
// State
// ========================================
const API = window.location.origin;
let summaryData = null;
let allDatasets = [];
let allRepos = [];
let dsSortKey = 'downloads', dsSortAsc = false;
let ghSortKey = 'stars', ghSortAsc = false;
let categoryChart = null;
let allRedditPosts = [];
let rdSortKey = 'score', rdSortAsc = false;
let trendChart = null, catTrendChart = null;
const loaded = { overview: false, datasets: false, github: false, papers: false, blogs: false, reddit: false, search: false, trends: false };

// ========================================
// API
// ========================================
async function fetchAPI(path) {
  try {
    const res = await fetch(API + path);
    if (!res.ok) return null;
    return await res.json();
  } catch (e) { console.error('Fetch error:', path, e); return null; }
}

// ========================================
// Tab switching
// ========================================
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach((b, i) => {
    b.classList.toggle('active', ['overview','datasets','github','papers','blogs','reddit','search','trends'][i] === name);
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  if (!loaded[name]) {
    loaded[name] = true;
    if (name === 'overview') loadOverview();
    else if (name === 'datasets') loadDatasets();
    else if (name === 'github') loadGithub();
    else if (name === 'papers') loadPapers();
    else if (name === 'blogs') loadBlogs();
    else if (name === 'reddit') loadReddit();
    else if (name === 'search') { /* search is on-demand */ loaded.search = true; }
    else if (name === 'trends') loadTrends();
  }
}

// ========================================
// Health check
// ========================================
async function checkHealth() {
  const data = await fetchAPI('/health');
  const dot = document.getElementById('health-dot');
  if (data && data.status === 'ok') {
    dot.className = 'w-2.5 h-2.5 rounded-full bg-green-500 inline-block';
    if (data.report_generated_at) {
      const t = new Date(data.report_generated_at);
      document.getElementById('scan-time').textContent = '最近扫描: ' + t.toLocaleString('zh-CN');
    }
  } else {
    dot.className = 'w-2.5 h-2.5 rounded-full bg-red-500 inline-block';
  }
}

// ========================================
// Overview
// ========================================
async function loadOverview() {
  const data = await fetchAPI('/summary');
  if (!data || !data.summary) {
    document.getElementById('panel-overview').innerHTML = '<div class="loading">暂无报告数据。请先运行扫描：<code>POST /scan</code></div>';
    return;
  }
  summaryData = data;
  const s = data.summary;
  document.getElementById('m-datasets').textContent = s.total_datasets || 0;
  document.getElementById('m-repos').textContent = s.total_github_repos || 0;
  document.getElementById('m-papers').textContent = s.total_papers || 0;
  document.getElementById('m-blogs').textContent = s.total_blog_posts || 0;
  document.getElementById('m-reddit').textContent = s.total_reddit_posts || 0;

  // Load datasets for chart + top 10
  const dsData = await fetchAPI('/datasets?limit=500');
  if (dsData && dsData.datasets) {
    renderCategoryChart(dsData.datasets);
    renderTopDatasets(dsData.datasets);
  }
}

function renderCategoryChart(datasets) {
  const counts = {};
  datasets.forEach(d => {
    const cat = d.category || 'other';
    counts[cat] = (counts[cat] || 0) + 1;
  });
  const labels = Object.keys(counts);
  const values = Object.values(counts);
  const colors = ['#38bdf8','#a78bfa','#f472b6','#fb923c','#4ade80','#fbbf24','#f87171','#94a3b8','#2dd4bf','#818cf8'];

  const ctx = document.getElementById('chart-categories').getContext('2d');
  if (categoryChart) categoryChart.destroy();
  categoryChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels.map(l => l.replace(/_/g, ' ')),
      datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }]
    },
    options: {
      responsive: true, maintainAspectRatio: true,
      plugins: {
        legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 11 }, padding: 8, boxWidth: 12 } }
      },
      cutout: '55%'
    }
  });
}

function renderTopDatasets(datasets) {
  const sorted = [...datasets].sort((a, b) => (b.downloads || 0) - (a.downloads || 0)).slice(0, 10);
  const tbody = document.getElementById('top-datasets');
  tbody.innerHTML = sorted.map(d => `<tr>
    <td><a href="https://huggingface.co/datasets/${esc(d.id)}" target="_blank">${esc(d.id) || '-'}</a></td>
    <td><span class="badge badge-blue">${esc((d.category || 'other').replace(/_/g, ' '))}</span></td>
    <td>${fmtNum(d.downloads)}</td>
  </tr>`).join('');
}

// ========================================
// Datasets
// ========================================
async function loadDatasets() {
  const el = document.getElementById('ds-loading');
  el.style.display = 'block';
  const cat = document.getElementById('ds-category').value;
  const q = cat ? `?category=${cat}&limit=500` : '?limit=500';
  const data = await fetchAPI('/datasets' + q);
  el.style.display = 'none';
  if (!data) return;
  allDatasets = data.datasets || [];
  renderDatasets();
}

function filterDatasets() {
  renderDatasets();
}

function sortDatasets(key) {
  if (dsSortKey === key) dsSortAsc = !dsSortAsc;
  else { dsSortKey = key; dsSortAsc = false; }
  renderDatasets();
}

function renderDatasets() {
  const search = (document.getElementById('ds-search').value || '').toLowerCase();
  let ds = allDatasets;
  if (search) ds = ds.filter(d => (d.id || '').toLowerCase().includes(search) || (d.author || '').toLowerCase().includes(search) || (d.description || '').toLowerCase().includes(search));

  ds = [...ds].sort((a, b) => {
    let va = a[dsSortKey] ?? '', vb = b[dsSortKey] ?? '';
    if (typeof va === 'number') return dsSortAsc ? va - vb : vb - va;
    return dsSortAsc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
  });

  document.getElementById('ds-count').textContent = `共 ${ds.length} 个数据集`;
  const tbody = document.getElementById('ds-tbody');
  tbody.innerHTML = ds.slice(0, 200).map(d => `<tr>
    <td><a href="https://huggingface.co/datasets/${esc(d.id)}" target="_blank">${esc(d.id) || '-'}</a></td>
    <td>${esc(d.author) || '-'}</td>
    <td><span class="badge badge-blue">${esc((d.category || 'other').replace(/_/g, ' '))}</span></td>
    <td>${fmtNum(d.downloads)}</td>
    <td>${fmtNum(d.likes)}</td>
    <td>${esc((d.languages || []).join(', ')) || '-'}</td>
    <td class="text-xs">${esc(Array.isArray(d.license) ? d.license[0] : (d.license || '-'))}</td>
  </tr>`).join('');
}

// ========================================
// GitHub
// ========================================
async function loadGithub() {
  const el = document.getElementById('gh-loading');
  el.style.display = 'block';
  const rel = document.getElementById('gh-relevance').value;
  const data = await fetchAPI(`/github?relevance=${rel}&limit=500`);
  el.style.display = 'none';
  if (!data) return;
  allRepos = data.repos || [];
  renderGithub();
}

function sortGithub(key) {
  if (ghSortKey === key) ghSortAsc = !ghSortAsc;
  else { ghSortKey = key; ghSortAsc = false; }
  renderGithub();
}

function renderGithub() {
  let repos = [...allRepos].sort((a, b) => {
    let va = a[ghSortKey] ?? '', vb = b[ghSortKey] ?? '';
    if (typeof va === 'number') return ghSortAsc ? va - vb : vb - va;
    return ghSortAsc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
  });

  document.getElementById('gh-count').textContent = `共 ${repos.length} 个仓库`;
  const tbody = document.getElementById('gh-tbody');
  if (repos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-slate-500 py-6">无匹配仓库</td></tr>';
    return;
  }
  tbody.innerHTML = repos.slice(0, 200).map(r => `<tr>
    <td><a href="${esc(r.url) || '#'}" target="_blank">${esc(r.full_name || r.name) || '-'}</a></td>
    <td>${fmtNum(r.stars)}</td>
    <td>${esc(r.language) || '-'}</td>
    <td class="text-xs">${esc(r.updated_at) || '-'}</td>
    <td>${(r.relevance_signals || r.signals || []).slice(0, 3).map(s => `<span class="badge badge-green">${esc(s)}</span>`).join(' ')}</td>
  </tr>`).join('');
}

// ========================================
// Papers
// ========================================
async function loadPapers() {
  const el = document.getElementById('pp-loading');
  el.style.display = 'block';
  const src = document.getElementById('pp-source').value;
  const dsOnly = document.getElementById('pp-dataset').checked;
  const data = await fetchAPI(`/papers?source=${src}&dataset_only=${dsOnly}&limit=200`);
  el.style.display = 'none';
  if (!data) return;
  const papers = data.papers || [];
  document.getElementById('pp-count').textContent = `共 ${papers.length} 篇论文`;

  document.getElementById('pp-list').innerHTML = papers.map(p => {
    const srcBadge = p.source === 'arxiv'
      ? '<span class="badge badge-orange">arXiv</span>'
      : '<span class="badge badge-purple">HuggingFace</span>';
    const authors = Array.isArray(p.authors) ? p.authors.slice(0, 3).join(', ') : (p.authors || '');
    return `<div class="card">
      <div class="flex items-start justify-between gap-4">
        <div>
          <a href="${esc(p.url || p.pdf_url) || '#'}" target="_blank" class="font-medium">${esc(p.title) || '-'}</a>
          <div class="text-xs text-slate-500 mt-1">${esc(authors)}${p.authors && p.authors.length > 3 ? ' ...' : ''}</div>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          ${srcBadge}
          <span class="text-xs text-slate-500">${esc(p.created_at || p.published_at) || ''}</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

// ========================================
// Blogs
// ========================================
async function loadBlogs() {
  const el = document.getElementById('bl-loading');
  el.style.display = 'block';
  const cat = document.getElementById('bl-category').value;
  const data = await fetchAPI(`/blogs?category=${cat}&limit=500`);
  el.style.display = 'none';
  if (!data) return;

  const articles = data.articles || [];
  // Group by source
  const groups = {};
  articles.forEach(a => {
    const src = a.source || '未知';
    if (!groups[src]) groups[src] = [];
    groups[src].push(a);
  });

  const totalSources = Object.keys(groups).length;
  document.getElementById('bl-count').textContent = `共 ${articles.length} 篇文章，来自 ${totalSources} 个来源`;

  const listEl = document.getElementById('bl-list');
  if (articles.length === 0) {
    listEl.innerHTML = '<div class="card text-center text-slate-500 py-8">本次扫描未发现新博客文章</div>';
    return;
  }
  listEl.innerHTML = Object.entries(groups).map(([src, arts], idx) => `
    <div class="blog-group">
      <div class="blog-header" onclick="this.nextElementSibling.classList.toggle('open')">
        <div class="flex items-center gap-2">
          <span class="font-medium text-sm">${esc(src)}</span>
          ${arts[0].category ? `<span class="badge badge-blue">${esc(arts[0].category)}</span>` : ''}
          <span class="badge badge-gray">${arts.length} 篇</span>
        </div>
        <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </div>
      <div class="blog-body${idx < 3 ? ' open' : ''}">
        ${arts.map(a => `<div class="py-2 border-t border-border/50">
          <a href="${esc(a.url) || '#'}" target="_blank" class="text-sm">${esc(a.title) || '-'}</a>
          <div class="text-xs text-slate-500 mt-0.5">${esc(a.date || a.published_at) || ''}</div>
          ${a.summary ? `<div class="text-xs text-slate-400 mt-1">${esc(a.summary.slice(0, 150))}</div>` : ''}
        </div>`).join('')}
      </div>
    </div>
  `).join('');
}

// ========================================
// Reddit
// ========================================
async function loadReddit() {
  const el = document.getElementById('rd-loading');
  el.style.display = 'block';
  const sub = document.getElementById('rd-subreddit').value;
  const minScore = parseInt(document.getElementById('rd-min-score').value) || 0;
  let q = `?limit=200&min_score=${minScore}`;
  if (sub) q += `&subreddit=${encodeURIComponent(sub)}`;
  const data = await fetchAPI('/reddit' + q);
  el.style.display = 'none';
  if (!data) return;
  allRedditPosts = data.posts || [];

  // Populate subreddit filter dropdown
  const sel = document.getElementById('rd-subreddit');
  const current = sel.value;
  const subs = [...new Set(allRedditPosts.map(p => p.subreddit))].sort();
  sel.innerHTML = '<option value="">全部子版</option>' + subs.map(s => `<option value="${esc(s)}"${s === current ? ' selected' : ''}>${esc(s)}</option>`).join('');

  renderReddit();
}

function sortReddit(key) {
  if (rdSortKey === key) rdSortAsc = !rdSortAsc;
  else { rdSortKey = key; rdSortAsc = false; }
  renderReddit();
}

function renderReddit() {
  const sub = document.getElementById('rd-subreddit').value;
  let posts = allRedditPosts;
  if (sub) posts = posts.filter(p => p.subreddit === sub);

  posts = [...posts].sort((a, b) => {
    let va = a[rdSortKey] ?? '', vb = b[rdSortKey] ?? '';
    if (typeof va === 'number') return rdSortAsc ? va - vb : vb - va;
    return rdSortAsc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
  });

  document.getElementById('rd-count').textContent = `共 ${posts.length} 个帖子`;
  const tbody = document.getElementById('rd-tbody');
  if (posts.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-slate-500 py-6">无匹配帖子</td></tr>';
    return;
  }
  tbody.innerHTML = posts.slice(0, 200).map(p => `<tr>
    <td class="font-mono">${p.score || 0}</td>
    <td><a href="${esc(p.url) || '#'}" target="_blank">${esc(p.title) || '-'}</a></td>
    <td><span class="badge badge-purple">${esc(p.subreddit)}</span></td>
    <td>${p.num_comments || 0}</td>
    <td>${(p.signals || []).slice(0, 3).map(s => `<span class="badge badge-green">${esc(s)}</span>`).join(' ')}</td>
    <td class="text-xs">${esc(p.author) || '-'}</td>
  </tr>`).join('');
}

// ========================================
// Search
// ========================================
async function runSearch() {
  const q = document.getElementById('sr-query').value.trim();
  if (!q) return;
  const el = document.getElementById('sr-loading');
  el.style.display = 'block';
  const data = await fetchAPI(`/search?q=${encodeURIComponent(q)}&limit=20`);
  el.style.display = 'none';
  if (!data) return;

  const results = data.results || {};
  document.getElementById('sr-count').textContent = `共 ${data.total || 0} 条结果`;

  const sections = [];
  if (results.datasets && results.datasets.length) {
    sections.push(`<div class="card"><h3 class="text-sm font-semibold text-slate-400 mb-2">数据集 (${results.datasets.length})</h3>
      ${results.datasets.map(d => `<div class="py-1 border-t border-border/50"><a href="https://huggingface.co/datasets/${esc(d.id)}" target="_blank" class="text-sm">${esc(d.id)}</a> <span class="badge badge-blue">${esc(d.category || '')}</span></div>`).join('')}
    </div>`);
  }
  if (results.github && results.github.length) {
    sections.push(`<div class="card"><h3 class="text-sm font-semibold text-slate-400 mb-2">GitHub (${results.github.length})</h3>
      ${results.github.map(r => `<div class="py-1 border-t border-border/50"><a href="${esc(r.url) || '#'}" target="_blank" class="text-sm">${esc(r.full_name || r.name)}</a> <span class="text-xs text-slate-500">★${r.stars || 0}</span></div>`).join('')}
    </div>`);
  }
  if (results.papers && results.papers.length) {
    sections.push(`<div class="card"><h3 class="text-sm font-semibold text-slate-400 mb-2">论文 (${results.papers.length})</h3>
      ${results.papers.map(p => `<div class="py-1 border-t border-border/50"><a href="${esc(p.url || p.pdf_url) || '#'}" target="_blank" class="text-sm">${esc(p.title)}</a></div>`).join('')}
    </div>`);
  }
  if (results.blogs && results.blogs.length) {
    sections.push(`<div class="card"><h3 class="text-sm font-semibold text-slate-400 mb-2">博客 (${results.blogs.length})</h3>
      ${results.blogs.map(a => `<div class="py-1 border-t border-border/50"><a href="${esc(a.url) || '#'}" target="_blank" class="text-sm">${esc(a.title)}</a> <span class="text-xs text-slate-500">${esc(a.source || '')}</span></div>`).join('')}
    </div>`);
  }
  if (results.reddit && results.reddit.length) {
    sections.push(`<div class="card"><h3 class="text-sm font-semibold text-slate-400 mb-2">Reddit (${results.reddit.length})</h3>
      ${results.reddit.map(p => `<div class="py-1 border-t border-border/50"><a href="${esc(p.url) || '#'}" target="_blank" class="text-sm">${esc(p.title)}</a> <span class="badge badge-purple">${esc(p.subreddit || '')}</span></div>`).join('')}
    </div>`);
  }
  document.getElementById('sr-results').innerHTML = sections.length ? sections.join('') : '<div class="card text-center text-slate-500 py-8">无匹配结果</div>';
}

// ========================================
// Trends
// ========================================
async function loadTrends() {
  const el = document.getElementById('tr-loading');
  el.style.display = 'block';
  const data = await fetchAPI('/trends?limit=30');
  el.style.display = 'none';
  if (!data || !data.timeline || data.timeline.length === 0) {
    document.getElementById('panel-trends').innerHTML = '<div class="loading">暂无历史趋势数据。至少需要 2 次扫描记录。</div>';
    return;
  }

  const timeline = data.timeline;
  const dates = timeline.map(t => t.date);
  const trendColors = ['#38bdf8', '#a78bfa', '#f472b6', '#fb923c', '#4ade80'];

  // Source trends line chart
  const ctx1 = document.getElementById('chart-trends').getContext('2d');
  if (trendChart) trendChart.destroy();
  trendChart = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [
        { label: '数据集', data: timeline.map(t => t.datasets), borderColor: trendColors[0], backgroundColor: trendColors[0] + '33', fill: true, tension: 0.3 },
        { label: '仓库', data: timeline.map(t => t.repos), borderColor: trendColors[1], fill: false, tension: 0.3 },
        { label: '论文', data: timeline.map(t => t.papers), borderColor: trendColors[2], fill: false, tension: 0.3 },
        { label: '博客', data: timeline.map(t => t.blogs), borderColor: trendColors[3], fill: false, tension: 0.3 },
        { label: 'Reddit', data: timeline.map(t => t.reddit), borderColor: trendColors[4], fill: false, tension: 0.3 },
      ],
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#94a3b8', font: { size: 11 } } } },
      scales: {
        x: { ticks: { color: '#64748b', maxRotation: 45 }, grid: { color: '#1e293b' } },
        y: { ticks: { color: '#64748b' }, grid: { color: '#1e293b' } },
      },
    },
  });

  // Category distribution bar chart
  const catData = data.datasets_by_category || {};
  const catLabels = Object.keys(catData);
  if (catLabels.length && dates.length) {
    const ctx2 = document.getElementById('chart-category-trends').getContext('2d');
    if (catTrendChart) catTrendChart.destroy();
    const chartColors = ['#38bdf8','#a78bfa','#f472b6','#fb923c','#4ade80','#fbbf24','#f87171','#94a3b8','#2dd4bf','#818cf8','#e879f9'];
    catTrendChart = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: dates,
        datasets: catLabels.map((cat, i) => ({
          label: cat.replace(/_/g, ' '),
          data: dates.map(d => (catData[cat] || {})[d] || 0),
          backgroundColor: chartColors[i % chartColors.length] + 'cc',
        })),
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: '#94a3b8', font: { size: 10 } } } },
        scales: {
          x: { stacked: true, ticks: { color: '#64748b', maxRotation: 45 }, grid: { color: '#1e293b' } },
          y: { stacked: true, ticks: { color: '#64748b' }, grid: { color: '#1e293b' } },
        },
      },
    });
  }
}

// ========================================
// Helpers
// ========================================
function esc(s) {
  if (s == null) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

function fmtNum(n) {
  if (n == null) return '-';
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return String(n);
}

// ========================================
// Init
// ========================================
checkHealth();
loaded.overview = true;
loadOverview();
</script>
</body>
</html>
